<!doctype html>

<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SpotWise</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { background: #000; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .leaflet-popup-content { color:#111; }/* Ponto de localiza√ß√£o com anel pulsante */
.you { position: relative; width:10px; height:10px; background:#00d1ff; border:2px solid #fff; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.3); }
.you::after { content:""; position:absolute; left:50%; top:50%; width:20px; height:20px; margin-left:-10px; margin-top:-10px; border:2px solid #00d1ff; border-radius:50%; opacity:.7; animation: youPulse 1.8s ease-out infinite; }
@keyframes youPulse { 0% { transform: scale(0.6); opacity:.8; } 70% { transform: scale(1.6); opacity:0; } 100% { opacity:0; } }

/* Rodap√© responsivo, espessura fixa */
.creditbar { position: fixed; inset: auto 0 0 0; z-index: 500;
  display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.7); color: #000; text-align: center;
  height: 28px; line-height: 28px; padding: 0 12px;
  font-size: clamp(10px, 2.2vw, 13px); font-weight: 500; letter-spacing: .2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  -webkit-user-select: none; user-select: none; pointer-events: none;
  backdrop-filter: saturate(180%) blur(2px);
}
.creditbar .brand-left { position: absolute; left: 8px; top: 0; bottom: 0; display: flex; align-items: center; font-weight: 700; opacity: .9; pointer-events: none; }

/* Barra de a√ß√µes (2 bot√µes harm√¥nicos) */
.actionbar { position: fixed; left: 0; right: 0; z-index: 900; display: flex; justify-content: center; align-items: center;
  bottom: calc(36px + env(safe-area-inset-bottom)); pointer-events: auto; }
.actionwrap { display: flex; gap: 8px; width: min(420px, 92vw); padding: 0 6px; }
.btn { border: 0; height: 34px; padding: 0 12px; border-radius: 10px; background: rgba(0,0,0,.55); color: #fff;
  font-size: clamp(12px, 2.6vw, 13px); font-weight: 700; letter-spacing: .3px;
  box-shadow: 0 6px 14px rgba(0,0,0,.26);
  backdrop-filter: saturate(180%) blur(4px);
  text-align: center; cursor: pointer; flex: 1 1 0; min-width: 0; }
.btn:active { transform: translateY(1px); }
.btn:focus-visible { outline: 2px solid rgba(255,255,255,.75); outline-offset: 2px; }
.btn-blue { background: rgba(37,99,235,.90); color:#fff; }
.btn-blue.active { background: rgba(37,99,235,1); }
.btn-wa { background: #25D366; color:#0b3e23; }
.btn-wa.active { filter: brightness(0.95); }

/* B√∫ssola */
.compass { position: fixed; top: 8px; right: 8px; z-index: 1200;
  width: 38px; height: 38px; border-radius: 12px; background: rgba(0,0,0,.55); box-shadow: 0 6px 16px rgba(0,0,0,.25);
  display: flex; align-items: center; justify-content: center; backdrop-filter: saturate(180%) blur(4px); }
.compass .dial { position: relative; width: 26px; height: 26px; border-radius: 50%; background: rgba(255,255,255,.85); }
.compass .needle { position: absolute; left: 50%; top: 50%; width: 0; height: 0; transform: translate(-50%, -80%) rotate(0deg);
  border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 12px solid #e11d48; }
.compass .n { position:absolute; left:50%; top:-10px; transform: translateX(-50%); font-size: 9px; color:#fff; opacity:.8; }

  </style>
</head>
<body>
  <div id="map"></div>
  <div id="compass" class="compass" aria-label="B√∫ssola" title="B√∫ssola">
    <div class="dial"><div class="needle" id="needle"></div></div>
    <div class="n">N</div>
  </div>  <div id="actionBar" class="actionbar">
    <div class="actionwrap">
      <button id="btnPrintBlue" class="btn btn-blue" type="button" aria-label="Capturar">Capturar</button>
      <button id="btnShare" class="btn btn-wa" type="button" aria-label="Compartilhar no WhatsApp">Compartilhar</button>
    </div>
  </div>  <div id="creditBar" class="creditbar">
    <span class="brand-left">SpotWise</span>
    Feito com ‚ù§Ô∏è por Everton Tezzon Ferreira
  </div>  <!-- Toast de informa√ß√£o -->  <div id="toast" style="position:fixed; left:50%; transform:translateX(-50%); bottom: calc(66px + env(safe-area-inset-bottom)); z-index:1100; background: rgba(0,0,0,.72); color:#fff; border-radius:10px; padding:8px 10px; font-size:12px; line-height:1.3; max-width:min(92vw,560px); text-align:center; display:none; box-shadow:0 6px 16px rgba(0,0,0,.3); pointer-events:none;"></div>  <!-- Scripts -->  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>  <script>
    // ===== Config =====
    const ESRI_URL = "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";
    const MT_KEY = "tSluSTAGCWjjyqc655pn"; // MapTiler API key
    const MT_URL = `https://api.maptiler.com/tiles/satellite/{z}/{x}/{y}.jpg?key=${MT_KEY}`;

    // ===== Mapa =====
    const map = L.map('map', { zoomControl: false }).setView([START_FALLBACK.lat, START_FALLBACK.lng], START_FALLBACK.z);

    // Camadas base
    const esriLayer = L.tileLayer(ESRI_URL, {
      tileSize: 256, minZoom: 0, maxZoom: 19, maxNativeZoom: 17, detectRetina: true, crossOrigin: true,
      attribution: 'Imagery ¬© Esri'
    });
    const mapTilerLayer = L.tileLayer(MT_URL, {
      tileSize: 256, minZoom: 0, maxZoom: 22, maxNativeZoom: 20, detectRetina: true, crossOrigin: true,
      attribution: '&copy; <a href="https://www.maptiler.com/" target="_blank" rel="noopener">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors'
    });

    // Restaura provedor preferido
    const storedBase = localStorage.getItem('base_provider');
    const defaultBase = storedBase === 'MapTiler' ? mapTilerLayer : esriLayer;
    defaultBase.addTo(map);

    // Controle de camadas (discreto)
    const baseLayers = { 'Esri Sat√©lite': esriLayer, 'MapTiler Sat√©lite': mapTilerLayer };
    L.control.layers(baseLayers, null, { collapsed: true, position: 'topleft' }).addTo(map);
    map.on('baselayerchange', (e)=>{ localStorage.setItem('base_provider', e.name === 'MapTiler Sat√©lite' ? 'MapTiler' : 'Esri'); });

    // ===== Ajuste rodap√© (espessura fixa) =====
    (function syncCreditBar(){
      const bar = document.getElementById('creditBar');
      function apply(){ document.documentElement.style.setProperty('--creditbar-h', '28px'); }
      map.whenReady(apply); window.addEventListener('resize', apply); setTimeout(apply, 0);
    })();

    // ===== B√∫ssola =====
    const needleEl = document.getElementById('needle');
    function updateCompass(deg){ if (needleEl) needleEl.style.transform = `translate(-50%, -80%) rotate(${deg||0}deg)`; }
    (function initDeviceOrientation(){
      if (!('DeviceOrientationEvent' in window)) return;
      function onPermitted(){ window.addEventListener('deviceorientation', (ev)=>{
        const anyEv = ev; const webkitHeading = anyEv && anyEv.webkitCompassHeading; let deg = null;
        if (typeof webkitHeading === 'number') deg = webkitHeading; else if (typeof ev.alpha === 'number') deg = 360 - ev.alpha;
        if (deg != null && isFinite(deg)) updateCompass(deg);
      }, true); }
      try { if (typeof DeviceOrientationEvent.requestPermission === 'function') { DeviceOrientationEvent.requestPermission().then(s=>{ if (s==='granted') onPermitted(); }); } else { onPermitted(); } } catch(e){}
    })();

    // ===== Geolocaliza√ß√£o =====
    const youIcon = L.divIcon({ className: 'you', html: '', iconSize: [10,10], iconAnchor: [5,5] });
    let youDot = null; let fixSamples = []; const MAX_SAMPLES = 8; let lastAvg = null;
    function updateYou(pos){ const { latitude:lat, longitude:lng } = pos.coords; youDot ? youDot.setLatLng([lat,lng]) : youDot = L.marker([lat,lng], {icon:youIcon, title:'Voc√™'}).addTo(map); }
    function averageFix(samples){ if(!samples.length) return null; const n=samples.length; const lat=samples.reduce((s,p)=>s+p.coords.latitude,0)/n; const lng=samples.reduce((s,p)=>s+p.coords.longitude,0)/n; const acc=samples.reduce((s,p)=>s+(p.coords.accuracy||0),0)/n; return { coords:{latitude:lat, longitude:lng, accuracy:acc, heading:samples[n-1].coords.heading}, timestamp:Date.now() }; }
    function onGeoSuccess(pos){
      fixSamples.push(pos);
      if (fixSamples.length>MAX_SAMPLES) fixSamples.shift();
      const avg=averageFix(fixSamples);
      if(!avg) return;
      lastAvg=avg; updateYou(avg);
      if (!onGeoSuccess._centered) { map.setView([avg.coords.latitude, avg.coords.longitude], DEFAULT_ZOOM_ON_FIX); onGeoSuccess._centered=true; }
    }
    function onGeoError(err){ console.error('Erro GPS:', err && err.message ? err.message : err); }
    async function initGeolocation(){
      if(!('geolocation' in navigator)) return;
      try {
        navigator.geolocation.getCurrentPosition((pos)=>{
          if(!onGeoSuccess._centered){ updateYou(pos); map.setView([pos.coords.latitude, pos.coords.longitude], QUICK_ZOOM_ON_HINT); }
        }, ()=>{}, { enableHighAccuracy:false, maximumAge:120000, timeout:3000 });
      } catch(e){}
      try {
        if (navigator.permissions && navigator.permissions.query){
          const perm = await navigator.permissions.query({name:'geolocation'});
          if (perm && perm.state==='denied') return;
        }
      } catch(e){}
      try {
        navigator.geolocation.watchPosition(onGeoSuccess, onGeoError, { enableHighAccuracy:true, maximumAge:10000, timeout:20000 });
      } catch(e){ console.error('watchPosition exception', e); }
    }

    // ===== Util localiza√ß√£o / toast =====
    function getLocationInfo(){
      const src = lastAvg ? { lat:lastAvg.coords.latitude, lng:lastAvg.coords.longitude } : (youDot ? youDot.getLatLng() : null);
      if (!src || typeof src.lat !== 'number' || typeof src.lng !== 'number') return null;
      const lat = Number(src.lat).toFixed(6);
      const lng = Number(src.lng).toFixed(6);
      const link = `https://maps.google.com/?q=${lat},${lng}`;
      return { lat, lng, link };
    }
    function showToast(msg){ const el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>{ el.style.display='none'; }, 3500); }
    function buildShareMessage(info){ return `üìç Localiza√ß√£o\nLat / Long: ${info.lat}, ${info.lng}\nLink: ${info.link}`; }
    function openWhatsAppWith(text){ const url = 'https://wa.me/?text=' + encodeURIComponent(text); window.open(url, '_blank'); }

    // ===== Captura (screenshot) =====
    const DB_NAME='app-storage'; const DB_STORE='screenshots';
    function openDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open(DB_NAME,1); req.onupgradeneeded=()=>{ const db=req.result; if(!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE,{keyPath:'id'}); }; req.onsuccess=()=>resolve(req.result); req.onerror=()=>reject(req.error); }); }
    async function saveScreenshot(blob, filename){
      try {
        const db=await openDB();
        await new Promise((resolve,reject)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).put({ id:filename, createdAt:Date.now(), blob }); tx.oncomplete=()=>resolve(); tx.onerror=()=>reject(tx.error); });
      } catch(e){ console.error('IndexedDB save failed', e); }
    }
    function tsFilename(){ const d=new Date(); const pad=(n)=>String(n).padStart(2,'0'); const name=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`; return `Mapa_${name}.png`; }
    async function takeScreenshot(){
      const scale=Math.min(3, Math.max(2, window.devicePixelRatio||2));
      try {
        const canvas=await html2canvas(document.body,{useCORS:true, backgroundColor:null, scale});
        const filename=tsFilename();
        canvas.toBlob(async (blob)=>{
          if(!blob){ console.error('Screenshot blob nulo'); return; }
          await saveScreenshot(blob, filename);
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 800);
        }, 'image/png');
      } catch(e){
        console.error('Falha no screenshot (CORS pode bloquear tiles do mapa).', e);
      }
    }

    // ===== Bot√µes =====
    const btnPrintBlue=document.getElementById('btnPrintBlue');
    const btnShare=document.getElementById('btnShare');

    btnPrintBlue?.addEventListener('click', async ()=>{ btnPrintBlue.classList.add('active'); btnPrintBlue.setAttribute('aria-pressed','true'); await takeScreenshot(); setTimeout(()=>{ btnPrintBlue.classList.remove('active'); btnPrintBlue.setAttribute('aria-pressed','false'); }, 400); });

    btnShare?.addEventListener('click', ()=>{ const info = getLocationInfo(); if (!info) { showToast('Sem posi√ß√£o ainda.'); return; } const msg = buildShareMessage(info); if (navigator.share) { navigator.share({ text: msg }).catch(()=> openWhatsAppWith(msg)); } else { openWhatsAppWith(msg); } const active = btnShare.classList.toggle('active'); btnShare.setAttribute('aria-pressed', active ? 'true' : 'false'); });

    // ===== Start =====
    initGeolocation();

    // ===== Self-tests (console) =====
    (function selfTests(){
      const li = { lat:'-23.550500', lng:'-46.633300', link:'https://maps.google.com/?q=-23.550500,-46.633300' };
      console.assert(buildShareMessage(li).includes('üìç'), 'share message sem emoji');
      const s = 'a\nb';
      console.assert(s.replace(/\n/g,' ‚Ä¢ ') === 'a ‚Ä¢ b', 'replace de quebra de linha falhou');
      const fn = tsFilename();
      console.assert(/^Mapa_\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2}\.png$/.test(fn), 'formato de nome de arquivo inv√°lido');
      console.assert(typeof saveScreenshot === 'function', 'saveScreenshot n√£o √© fun√ß√£o');
      console.assert(typeof esriLayer === 'object' && typeof mapTilerLayer === 'object', 'camadas base n√£o criadas');
      console.log('‚úÖ self-tests ok');
    })();
  </script></body>
</html>